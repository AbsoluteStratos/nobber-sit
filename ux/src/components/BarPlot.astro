---
---

<div class="chart-container">
  <div class="controls">
    <label>
      Emote:
      <select id="emote-select"></select>
    </label>

    <label>
      Range:
      <select id="range-select">
        <option value="30">Past 30 days</option>
        <option value="60">Past 60 days</option>
        <option value="all">All days</option>
      </select>
    </label>
  </div>

  <div id="chart"></div>

  <div id="top-users" class="top-users"></div>
</div>

<style>
  .chart-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    width: 100%;
    overflow: hidden;
  }

  .controls {
    margin-bottom: 16px;
    display: flex;
    gap: 20px;
    font-family: sans-serif;
    font-size: large;
    font-family: 'Comic Sans MS', cursive, sans-serif;
    color: salmon;
    text-shadow: 0 0 6px rgb(255, 255, 255), 0 0 12px rgb(255, 255, 255);
  }

  
  @media (max-width: 600px) {
    .controls {
      flex-direction: column; /* stack in a column on mobile */
      gap: 12px;              /* adjust spacing for vertical layout */
      align-items: center;   /* make selects fill width if you want */
    }
  }

  @media (max-height: 1000px) {
    .controls {
      margin-top: 100px;
    }
  }


  select {
    padding: 4px 8px;
    border: 3px solid salmon;
    color: salmon;
    border-radius: 8px;
  }

  #chart {
    width: 90%;
    max-width:1000px;
    height: 500px;
  }

  .top-users {
    margin-top: 20px;
    font-family: 'Comic Sans MS', cursive, sans-serif;
    text-align: left;
    max-width: 80%;
    background: #fff5f5;
    border: 3px solid salmon;
    color: salmon;
    border-radius: 8px;
    padding: 20px;
  }

  @media (max-width: 600px) {
    .top-users {
      margin-top: 60px;
    }
  }
  .top-users h3 {
    margin: 0 0 10px 0;
    color: salmon;
  }
  .top-users ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  .top-users li {
    margin: 4px 0;
  }
</style>

<script src="/scripts/plotly.2.27.0.js" defer></script>
<script client:load>
  async function initChart() {
    const res = await fetch("/daily_emote_totals.json");
    const rawTotals = await res.json();

    const res2 = await fetch("/user_emote_totals.json");
    const rawUsers = await res2.json();

    // Extract dates & emote keys
    // const dates = raw.dates;
    const emotes = Object.keys(rawTotals);

    // Populate emote dropdown
    const emoteSelect = document.getElementById("emote-select");
    emotes.forEach(e => {
      const opt = document.createElement("option");
      opt.value = e;
      opt.textContent = e;
      emoteSelect.appendChild(opt);
    });

    // Function to filter by range
    function filterRange(emote_data, range) {
      const dates = Object.keys(emote_data);
      const values =  Object.values(emote_data);
      let cutoff = new Date();
      if (range === "all"){
        cutoff = new Date(2025, 5, 1); // Month starts at 0
      } else {
        cutoff.setDate(cutoff.getDate() - parseInt(range))
      }

      const filtered = dates
        .map((d, i) => ({ date: new Date(d), value: values[i] }))
        .filter(d => d.date >= cutoff);
      return {
        dates: filtered.map(d => d.date.toISOString().slice(0, 10)),
        values: filtered.map(d => d.value)
      };
    }

    // Initial plot
    let currentEmote = "ohhnosSit";
    let currentRange = "30";
    document.getElementById("range-select").value = currentRange;
    emoteSelect.value = currentEmote;

    function updateTopUsers() {
      const container = document.getElementById("top-users");
      const userData = rawUsers[currentEmote] || {};
      const sorted = Object.entries(userData)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);

      container.innerHTML = `
        <h3>Top 5 users for ${currentEmote}</h3>
        <ul>
          ${sorted.map(([user, count]) => `<li>${user}: ${count}</li>`).join("")}
        </ul>
      `;
    }

    function updateChart() {
      const values = rawTotals[currentEmote];
      const { dates: x, values: y } = filterRange(values, currentRange);

      const trace = {
        x,
        y,
        type: "bar",
        marker: { color: "salmon" }
      };
      console.log(currentEmote)
      var  layout = {
        xaxis: { title: "Stream Date (EST)",  linewidth: 2 },
        yaxis: { title: "Count",  linewidth: 2,  gridcolor: "rgba(255,0,0,0.25)", gridwidth: 2},
        margin: { t: 50, b: 80 },
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        transition: { duration: 500, easing: "cubic-in-out" },
      };
      Plotly.react("chart", [trace], layout, { responsive: true });
      Plotly.update('chart', {}, { 'title.text': currentEmote+" Uses" });

    }

    // Event listeners
    emoteSelect.addEventListener("change", (e) => {
      currentEmote = e.target.value;
      updateChart();
      updateTopUsers();
    });

    document.getElementById("range-select").addEventListener("change", (e) => {
      currentRange = e.target.value;
      updateChart();
    });

    // Draw first chart
    updateChart();
    updateTopUsers();
  }

  initChart();
</script>
